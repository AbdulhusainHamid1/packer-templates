{
  "description": "Travis CI minimal build env template",
  "variables": {
    "cookbooks_branch": "{{ env `COOKBOOKS_BRANCH` }}",
    "cookbooks_sha": "{{ env `COOKBOOKS_SHA` }}",
    "travis_cookbooks_dir": "{{ env `TRAVIS_COOKBOOKS_DIR` }}",
    "vsphere_cluster": "{{ env `VSPHERE_CLUSTER` }}",
    "vsphere_datacenter": "{{ env `VSPHERE_DATACENTER` }}",
    "vsphere_datastore": "{{ env `VSPHERE_DATASTORE` }}",
    "vsphere_host": "{{ env `VSPHERE_HOST` }}",
    "vsphere_password": "{{ env `VSPHERE_PASSWORD` }}",
    "vsphere_resource_pool": "{{ env `VSPHERE_RESOURCE_POOL` }}",
    "vsphere_username": "{{ env `VSPHERE_USERNAME` }}",
    "vsphere_vm_folder": "{{ env `VSPHERE_VM_FOLDER` }}",
    "vsphere_vm_network": "{{ env `VSPHERE_VM_NETWORK` }}"
  },
  "builders": [
    {
      "type": "docker",
      "name": "docker",
      "pull": false,
      "image": "travis-base:latest",
      "run_command": [
        "--privileged",
        "-d",
        "-i",
        "-t",
        "{{ .Image }}",
        "/sbin/init"
      ]
    },
    {
      "type": "vmware-vmx",
      "name": "vmware-minimal",
      "vm_name": "packer-vmware-minimal",
      "source_path": "output-vmware-ubuntu-trusty-base/packer-vmware-ubuntu-trusty-base.vmx",
      "ssh_username": "vagrant",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "headless": true
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "scripts": [
        "packer-scripts/clone-travis-cookbooks"
      ],
      "environment_vars": [
        "COOKBOOKS_BRANCH={{ user `cookbooks_branch` }}"
      ],
      "execute_command": "{{ .Vars }} exec sudo -E -S bash '{{ .Path }}'"
    },
    {
      "type": "file",
      "source": "packer-assets/minimal-system-info-commands.yml",
      "destination": "/var/tmp/minimal-system-info-commands.yml"
    },
    {
      "type": "chef-solo",
      "cookbook_paths": [
        "cookbooks",
        "{{ user `travis_cookbooks_dir` }}/ci_environment"
      ],
      "remote_cookbook_paths": [
        "/tmp/chef-stuff/travis-cookbooks/ci_environment"
      ],
      "json": {
        "java": {
          "default_version": ""
        },
        "nodejs": {
          "default": "",
          "versions": [],
          "aliases": [],
          "default_modules": []
        },
        "python": {
          "pyenv": {
            "pythons": [],
            "aliases": {}
          },
          "pip": {
            "packages": {}
          },
          "system": {
            "pythons": []
          }
        },
        "rvm": {
          "default": "",
          "rubies": [
          ],
          "gems": [
          ],
          "prerequisite_recipes": [],
          "pkg_requirements": []
        },
        "system_info": {
          "use_bundler": false,
          "commands_file": "/var/tmp/minimal-system-info-commands.yml"
        },
        "travis_build_environment": {
          "use_tmpfs_for_builds": false,
          "update_hosts_atomically": false,
          "packages": [
            "autoconf",
            "automake",
            "bash",
            "bison",
            "build-essential",
            "bzip2",
            "bzr",
            "ca-certificates",
            "ccache",
            "cmake",
            "curl",
            "flex",
            "gawk",
            "gzip",
            "imagemagick",
            "iptables",
            "libbz2-dev",
            "libcurl4-openssl-dev",
            "libffi-dev",
            "libgdbm-dev",
            "libicu-dev",
            "libldap-2.4.2",
            "libldap2-dev",
            "libmagickwand-dev",
            "libncurses5-dev",
            "libncursesw5-dev",
            "libossp-uuid-dev",
            "libqt4-dev",
            "libreadline-dev",
            "libreadline6",
            "libsqlite3-dev",
            "libssl-dev",
            "libssl0.9.8",
            "libtool",
            "libxml2-dev",
            "libxslt-dev",
            "libxslt1-dev",
            "libyaml-0-2",
            "libyaml-dev",
            "lsof",
            "md5deep",
            "mercurial",
            "mingw32",
            "netcat-openbsd",
            "openssl",
            "pkg-config",
            "python",
            "qt4-qmake",
            "ragel",
            "rsync",
            "ruby2.0",
            "sqlite3",
            "sqlite3",
            "subversion",
            "unzip",
            "wamerican",
            "zip",
            "zlib1g-dev"
          ]
        }
      },
      "run_list": [
        "recipe[travis_ci_minimal]"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "vmware-toolbox-cmd disk shrink /",
        "vmware-toolbox-cmd disk shrink /boot"
      ],
      "execute_command": "{{ .Vars }} exec sudo -E -S bash '{{ .Path }}'"
    }
  ],
  "post-processors": [
    {
      "type": "docker-import",
      "repository": "travis-minimal",
      "tag": "{{ timestamp }}",
      "only": [
        "docker"
      ]
    }
  ]
}
