<%
@dist = ENV.fetch('CI_MINIMAL_DIST', 'trusty')
@image_prefix = ENV.fetch('CI_MINIMAL_IMAGE_PREFIX', 'travis')
%>
---
description: Travis CI minimal build env template
variables:
  cookbooks_branch: "{{ env `COOKBOOKS_BRANCH` }}"
  cookbooks_sha: "{{ env `COOKBOOKS_SHA` }}"
  gce_account_file: "{{ env `GCE_ACCOUNT_FILE` }}"
  gce_image_name: "<%= @image_prefix %>-ci-minimal-<%= @dist %>-{{ timestamp }}"
  gce_project_id: "{{ env `GCE_PROJECT_ID` }}"
  job_board_images_url: "{{ env `JOB_BOARD_IMAGES_URL` }}"
  <% if ENV['CI_MINIMAL_USE_LOCAL_COOKBOOKS'] %>
  travis_cookbooks_dir: "{{ env `TRAVIS_COOKBOOKS_DIR` }}"
  <% end %>
builders:
- type: googlecompute
  name: googlecompute
  communicator: ssh
  ssh_timeout: 10m
  ssh_port: 22
  image_description: Travis CI Minimal
  account_file: "{{ user `gce_account_file` }}"
  project_id: "{{ user `gce_project_id` }}"
  <% if @dist == 'trusty' %>
  source_image: ubuntu-1404-trusty-v20150909a
  <% else %>
  source_image: ubuntu-1204-precise-v20150910
  <% end %>
  zone: us-central1-a
  image_name: "{{ user `gce_image_name` }}"
  machine_type: n1-standard-4
  disk_size: 20
  tags:
  - ci
  - go
provisioners:
- type: shell
  inline: sleep 10
  only:
  - googlecompute
- type: file
  source: packer-assets/ubuntu-<%= @dist %>-normal-purge.txt
  destination: "/var/tmp/purge.txt"
- type: shell
  scripts:
  - packer-scripts/pre-chef-bootstrap
  - packer-scripts/remove-vagrant-user
  - packer-scripts/clone-travis-cookbooks
  environment_vars:
  - "COOKBOOKS_BRANCH={{ user `cookbooks_branch` }}"
  execute_command: "{{ .Vars }} exec sudo -E -S bash '{{ .Path }}'"
- type: file
  source: packer-assets/minimal-system-info-commands.yml
  destination: "/var/tmp/minimal-system-info-commands.yml"
- type: chef-solo
  cookbook_paths:
  - cookbooks
  remote_cookbook_paths:
  - "/tmp/chef-stuff/travis-cookbooks/cookbooks"
  - "/tmp/chef-stuff/travis-cookbooks/community-cookbooks"
  run_list:
  - "recipe[travis_ci_minimal]"
- type: shell
  scripts:
  - packer-scripts/cleanup
  - packer-scripts/ensure-travis-user
  - packer-scripts/disable-apparmor
  - packer-scripts/job-board-register
  - packer-scripts/minimize
  environment_vars:
  - "TRAVIS_OBFUSCATE_PASSWORD=1"
  - "JOB_BOARD_IMAGES_URL={{ user `job_board_images_url` }}"
  - "IMAGE_NAME={{ user `gce_image_name` }}"
  execute_command: "{{ .Vars }} exec sudo -E -S bash '{{ .Path }}'"
post-processors:
- type: atlas
  artifact: "travis-ci/ci-minimal"
  artifact_type: "google.image"
  metadata:
    name: "{{ user `gce_image_name` }}"
  only:
  - googlecompute
