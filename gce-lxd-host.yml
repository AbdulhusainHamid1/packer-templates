---
description: Travis GCE LXD Host
variables:
  aws_access_key: "{{ env `AWS_ACCESS_KEY` }}"
  aws_secret_key: "{{ env `AWS_SECRET_KEY` }}"
  gce_account_file: "{{ env `GCE_ACCOUNT_FILE` }}"
  gce_image_name: lxd-host-{{ timestamp }}-<%= git_desc %>
  gce_project_id: "{{ env `GCE_PROJECT_ID` }}"
  travis_cookbooks_branch: "{{ env `TRAVIS_COOKBOOKS_BRANCH` }}"
  travis_cookbooks_sha: "{{ env `TRAVIS_COOKBOOKS_SHA` }}"
  travis_subnet_id: "{{ env `TRAVIS_SUBNET_ID` }}"
  travis_vpc_id: "{{ env `TRAVIS_VPC_ID` }}"
  <% if !ENV['PACKER_TEMPLATES_BRANCH'].to_s.empty? %>
  clean_packer_templates_branch: <%= ENV['PACKER_TEMPLATES_BRANCH'].gsub(/[^-a-zA-Z0-9]/, '-').gsub(/^-/, '').gsub(/-$/, '') %>
  <% else %>
  clean_packer_templates_branch: notset
  <% end %>
  <% if !ENV['TRAVIS_COOKBOOKS_BRANCH'].to_s.empty? %>
  clean_travis_cookbooks_branch: <%= ENV['TRAVIS_COOKBOOKS_BRANCH'].gsub(/[^-a-zA-Z0-9]/, '-').gsub(/^-/, '').gsub(/-$/, '') %>
  <% else %>
  clean_travis_cookbooks_branch: notset
  <% end %>
builders:
- type: googlecompute
  name: googlecompute
  communicator: ssh
  ssh_timeout: 10m
  ssh_port: 22
  ssh_username: packer
  image_description: Travis GCE LXD Host
  account_file: "{{ user `gce_account_file` }}"
  project_id: "{{ user `gce_project_id` }}"
  source_image: ubuntu-1804-bionic-v20191113
  zone: us-central1-a
  image_name: "{{ user `gce_image_name` }}"
  machine_type: n2-standard-2
  tags:
  - lxd
  - travis-ci-packer-templates
  - "cookbooks-branch-{{ user `clean_travis_cookbooks_branch` }}"
  - "branch-{{ user `clean_packer_templates_branch` }}"
provisioners:
- type: shell
  inline:
    sudo rm -rf /var/lib/apt/lists* ;
    sudo apt-get update -yqq ;
    sudo apt-get install -f
- type: shell
  scripts:
  - packer-scripts/packer-env-dump
  - packer-scripts/gce-lxd-host
  - packer-scripts/purge
  - packer-scripts/install-ubuntu-mainline-kernel
  - packer-scripts/cleanup
  - packer-scripts/minimize
  environment_vars:
  - TRAVIS_OBFUSCATE_PASSWORD=1
  execute_command: "{{ .Vars }} exec sudo -E -S bash '{{ .Path }}'"
