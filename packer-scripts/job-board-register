#!/usr/bin/env bash

set -o errexit

if [[ -f /etc/default/job-board-register ]] ; then
  source /etc/default/job-board-register
fi

[[ $JOB_BOARD_IMAGES_URL ]] || {
  echo Missing \$JOB_BOARD_IMAGES_URL
  exit 1
}

[[ $IMAGE_NAME ]] || {
  echo Missing \$IMAGE_NAME
  exit 1
}

: ${TAGS:=group:dev}

if [[ $PACKER_BUILD_NAME ]] ; then
  TAGS="$TAGS,packer_build_name:$PACKER_BUILD_NAME"
fi

if [[ $PACKER_BUILDER_TYPE ]] ; then
  TAGS="$TAGS,packer_builder_type:$PACKER_BUILDER_TYPE"

  case "$PACKER_BUILDER_TYPE" in
    googlecompute) IMAGE_INFRA=gce ;;
    docker) IMAGE_INFRA=docker ;;
    vmware) IMAGE_INFRA=jupiterbrain ;;
  esac
fi

: ${IMAGE_INFRA:=local}

echo "time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
     "msg=\"registering with job board\"" \
     "name=${IMAGE_NAME} infra=${IMAGE_INFRA} tags=${TAGS}"

exec curl \
  -s \
  -X POST \
  "$JOB_BOARD_IMAGES_URL?infra=$IMAGE_INFRA&name=$IMAGE_NAME&tags=$TAGS"
