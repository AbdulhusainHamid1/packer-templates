{
  "description": "Travis CI meta docker import template",
  "variables": {
    "docker_import_image": "{{ env `DOCKER_IMPORT_IMAGE` }}",
    "docker_import_image_name": "{{ env `DOCKER_IMPORT_IMAGE_NAME` }}"
  },
  "builders": [
    {
      "type": "vmware-vmx",
      "name": "vmware-docker-import-{{ user `docker_import_image_name` }}",
      "vm_name": "vmware-docker-import-{{ user `docker_import_image_name` }}",
      "source_path": "output-vmware-ubuntu-precise-base/packer-vmware-ubuntu-precise-base.vmx",
      "ssh_username": "travis",
      "ssh_password": "travis",
      "ssh_port": 22,
      "ssh_wait_timeout": "10000s",
      "headless": true
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "set -ex",
        "cd /var/tmp",
        "curl https://get.docker.io | bash",
        "CONTAINER_ID=\"$(docker run -dit {{ user `docker_import_image` }} echo)\"",
        "docker export \"$CONTAINER_ID\" > /var/tmp/{{ user `docker_import_image_name` }}.tar",
        "stop docker",
        "cd /",
        "tar -xvf /var/tmp/{{ user `docker_import_image_name` }}.tar || echo 'tar error suppressed'"
     ],
      "execute_command": "{{ .Vars }} exec sudo -E -S bash '{{ .Path }}'"
    }
  ]
}
